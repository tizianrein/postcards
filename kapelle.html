<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script data-goatcounter="https://digitalfabricationtum.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

    <style>
      /* Main Overlay Container */
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-family: 'Georgia', serif;
        overflow: hidden;
      }

      /* Scanning Instructions */
      #scan-instructions {
        background: rgba(0, 0, 0, 0.6);
        padding: 20px;
        border-radius: 15px;
        color: white;
        transition: opacity 0.5s;
      }
      
      .instruction-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
      }
      
      .instruction-hint {
        font-size: 16px;
        color: #ddd;
      }

      /* Season's Greetings Message */
      #greetings {
        position: absolute;
        bottom: 10%;
        width: 100%;
        opacity: 0;
        transition: opacity 1s ease-in-out;
        z-index: 20; /* Ensure text is above snow */
      }

      .festive-text {
        font-size: 40px;
        font-weight: bold;
        background: linear-gradient(to right, #ff3333, #ff6b6b);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0px 2px 4px rgba(0,0,0,0.2);
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }

      /* SNOWFLAKE STYLES */
      .snowflake {
        position: absolute;
        top: -10px;
        color: white;
        font-size: 1em;
        opacity: 0.8;
        pointer-events: none;
        z-index: 5; /* Behind the text but over video */
        animation: fall linear forwards;
      }

      @keyframes fall {
        to {
          transform: translateY(110vh);
        }
      }

      /* Utilities */
      .hidden {
        opacity: 0 !important;
        pointer-events: none;
      }
      .visible {
        opacity: 1 !important;
      }
    </style>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const sceneEl = document.querySelector('a-scene');
        const target = document.querySelector('#my-target');
        const scanInstructions = document.querySelector('#scan-instructions');
        const greetings = document.querySelector('#greetings');
        const overlay = document.querySelector('#overlay');
        let snowInterval = null;

        // Function to create a single snowflake
        function createSnowflake() {
          const snowflake = document.createElement('div');
          snowflake.classList.add('snowflake');
          snowflake.textContent = 'â„'; // You can also use 'â€¢' for round snow
          
          // Randomize position and animation
          snowflake.style.left = Math.random() * 100 + 'vw';
          snowflake.style.animationDuration = Math.random() * 3 + 2 + 's'; // 2s to 5s fall speed
          snowflake.style.fontSize = Math.random() * 10 + 10 + 'px'; // 10px to 20px size
          snowflake.style.opacity = Math.random(); 

          overlay.appendChild(snowflake);

          // Remove snowflake after it falls to keep DOM light
          setTimeout(() => {
            snowflake.remove();
          }, 5000); 
        }

        function startSnow() {
          if (!snowInterval) {
            // Create a new snowflake every 100ms
            snowInterval = setInterval(createSnowflake, 100);
          }
        }

        function stopSnow() {
          if (snowInterval) {
            clearInterval(snowInterval);
            snowInterval = null;
          }
          // Optional: clear existing flakes immediately
          document.querySelectorAll('.snowflake').forEach(el => el.remove());
        }

        // Event: Target Found
        target.addEventListener("targetFound", event => {
          console.log("Target found");
          scanInstructions.classList.add("hidden");
          greetings.classList.add("visible");
          startSnow(); // <--- START SNOW!
        });

        // Event: Target Lost
        target.addEventListener("targetLost", event => {
          console.log("Target lost");
          scanInstructions.classList.remove("hidden");
          greetings.classList.remove("visible");
          stopSnow(); // <--- STOP SNOW (saves battery)
        });
      });
    </script>
  </head>
  <body>
    <!-- UI OVERLAY -->
    <div id="overlay">
      <!-- Scanning Instructions -->
      <div id="scan-instructions">
        <div class="instruction-title">Scan the Postcard</div>
        <div class="instruction-hint">Please move your phone slowly</div>
        <div style="margin-top:10px; font-size: 24px;">ðŸ“·</div>
      </div>

      <!-- Festive Greeting -->
      <div id="greetings">
        <div class="festive-text">
          Season's Greetings<br>
          <span style="font-size: 24px;">and a Happy New Year!</span>
        </div>
      </div>
    </div>

    <!-- AR SCENE -->
    <a-scene 
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/augmentedfabricationlab/xmas_cards@main/targets_tes.mind; filterMinCF:0.0005; filterBeta: 0.001; missTolerance: 50;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/augmentedfabricationlab/xmas_cards@refs/heads/main/tree_tes_2.gltf"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <a-entity id="my-target" mindar-image-target="targetIndex: 0">
        <a-gltf-model 
          rotation="0 0 0" 
          position="0 0 -0.1" 
          scale="50 50 50" 
          src="#avatarModel" 
          animation__rotation="property: rotation; to: 0 0 360; dur: 20000; loop: true; easing: linear">
        </a-gltf-model>
      </a-entity>
    </a-scene>
  </body>
</html>